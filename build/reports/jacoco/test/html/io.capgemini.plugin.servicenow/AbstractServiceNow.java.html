<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractServiceNow.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">plugin-servicenow</a> &gt; <a href="index.source.html" class="el_package">io.capgemini.plugin.servicenow</a> &gt; <span class="el_source">AbstractServiceNow.java</span></div><h1>AbstractServiceNow.java</h1><pre class="source lang-java linenums">package io.capgemini.plugin.servicenow;

import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
import io.kestra.core.exceptions.IllegalVariableEvaluationException;
import io.kestra.core.http.client.HttpClientResponseException;
import io.kestra.core.http.client.configurations.BasicAuthConfiguration;
import io.kestra.core.models.property.Property;
import io.kestra.core.models.tasks.Task;
import io.kestra.core.runners.RunContext;
import io.kestra.core.http.HttpRequest;
import io.kestra.core.http.HttpResponse;
import io.kestra.core.http.client.HttpClient;
import io.kestra.core.http.client.HttpClientException;
import io.kestra.core.http.client.configurations.HttpConfiguration;
import io.swagger.v3.oas.annotations.media.Schema;
import lombok.*;
import lombok.experimental.SuperBuilder;

import java.io.IOException;
import java.net.URI;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.util.Map;
import java.util.Objects;

import jakarta.validation.constraints.NotNull;


@SuperBuilder
@ToString
@EqualsAndHashCode
@Getter
@NoArgsConstructor
public abstract class AbstractServiceNow extends Task {
<span class="fc" id="L37">    private static final ObjectMapper MAPPER = new ObjectMapper()</span>
<span class="fc" id="L38">        .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false)</span>
<span class="fc" id="L39">        .registerModule(new JavaTimeModule());</span>

    @NotNull
    @Schema(
        title = &quot;ServiceNow domain.&quot;,
        description = &quot;Will be used to generate the URL: `https://[[DOMAIN]].service-now.com/`&quot;
    )
    private Property&lt;String&gt; domain;

    @NotNull
    @Schema(title = &quot;ServiceNow username.&quot;, description = &quot;to be used with 'password' for a BasicAuth authentication&quot;)
    private Property&lt;String&gt; username;

    @NotNull
    @Schema(title = &quot;ServiceNow password.&quot;, description = &quot;to be used with 'username'&quot;)
    private Property&lt;String&gt; password;

    @Schema(title = &quot;ServiceNow client ID.&quot;, description = &quot;to be used with 'clientSecret', 'username' and 'password' for a OAuth authentication&quot;)
    private Property&lt;String&gt; clientId;

    @Schema(title = &quot;ServiceNow client secret.&quot;, description = &quot;to be used with 'clientId'&quot;)
    private Property&lt;String&gt; clientSecret;

    @Schema(title = &quot;The headers to pass to the request&quot;)
    protected Property&lt;Map&lt;CharSequence, CharSequence&gt;&gt; headers;

    @Schema(title = &quot;The HTTP client configuration.&quot;)
    protected HttpConfiguration options;

    @Schema(
        title = &quot;Generic query parameters appended as `?key=value` pairs.&quot;,
        description = &quot;Intended for ServiceNow Table API endpoints (e.g., `sysparm_query`, `sysparm_fields`, `sysparm_limit`, `sysparm_display_value`). &quot; +
                      &quot;Values support templating. Iterable values emit repeated keys.&quot;
    )
    protected Property&lt;Map&lt;String, Object&gt;&gt; params;

    @Getter(AccessLevel.NONE)
    private transient String token;

    @Getter(AccessLevel.NONE)
    private transient String uri;

    protected String baseUri(RunContext runContext) throws IllegalVariableEvaluationException {
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        if (this.uri != null) {</span>
<span class="fc" id="L83">            return this.uri;</span>
        }
<span class="nc" id="L85">        return &quot;https://&quot; + runContext.render(this.domain).as(String.class).orElseThrow() + &quot;.service-now.com/&quot;;</span>
    }

    private String token(RunContext runContext) throws IllegalVariableEvaluationException, HttpClientException {
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">        if (this.token != null) {</span>
<span class="nc" id="L90">            return this.token;</span>
        }

<span class="fc" id="L93">        URI uri = URI.create(baseUri(runContext) + &quot;oauth_token.do&quot;);</span>

<span class="fc" id="L95">        Map&lt;String, Object&gt; requestBody = Map.of(</span>
            &quot;grant_type&quot;, &quot;password&quot;,
<span class="fc" id="L97">            &quot;client_id&quot;, runContext.render(this.clientId).as(String.class).orElseThrow(),</span>
<span class="fc" id="L98">            &quot;client_secret&quot;, runContext.render(this.clientSecret).as(String.class).orElseThrow(),</span>
<span class="fc" id="L99">            &quot;username&quot;, runContext.render(this.username).as(String.class).orElseThrow(),</span>
<span class="fc" id="L100">            &quot;password&quot;, runContext.render(this.password).as(String.class).orElseThrow()</span>
        );

<span class="fc" id="L103">        HttpRequest.HttpRequestBuilder requestBuilder = HttpRequest.builder()</span>
<span class="fc" id="L104">            .uri(uri)</span>
<span class="fc" id="L105">            .method(&quot;POST&quot;)</span>
<span class="fc" id="L106">            .body(HttpRequest.UrlEncodedRequestBody.builder().content(requestBody).build());</span>

<span class="pc bpc" id="L108" title="1 of 2 branches missed.">        if (this.headers != null) {</span>
<span class="nc" id="L109">            runContext.render(this.headers)</span>
<span class="nc" id="L110">                .asMap(CharSequence.class, CharSequence.class)</span>
<span class="nc" id="L111">                .forEach((key, value) -&gt; {</span>
                    try {
<span class="nc" id="L113">                        requestBuilder.addHeader(</span>
<span class="nc" id="L114">                            key.toString(),</span>
<span class="nc" id="L115">                            runContext.render(value.toString())</span>
                        );
<span class="nc" id="L117">                    } catch (IllegalVariableEvaluationException ex) {</span>
<span class="nc" id="L118">                        throw new RuntimeException(&quot;Failed to render header value&quot;, ex);</span>
<span class="nc" id="L119">                    }</span>
<span class="nc" id="L120">                });</span>
        }

<span class="fc" id="L123">        try (HttpClient client = new HttpClient(runContext, options)) {</span>
<span class="fc" id="L124">            HttpResponse&lt;Map&lt;String, String&gt;&gt; exchange = client.request(requestBuilder.build());</span>

<span class="fc" id="L126">            Map&lt;String, String&gt; tokenResponse = exchange.getBody();</span>
<span class="pc bpc" id="L127" title="2 of 4 branches missed.">            if (tokenResponse == null || !tokenResponse.containsKey(&quot;access_token&quot;)) {</span>
<span class="nc" id="L128">                throw new IllegalStateException(&quot;Invalid token request with response &quot; + tokenResponse);</span>
            }
<span class="fc" id="L130">            this.token = tokenResponse.get(&quot;access_token&quot;);</span>
<span class="fc" id="L131">            return this.token;</span>
<span class="nc" id="L132">        } catch (IOException e) {</span>
<span class="nc" id="L133">            throw new RuntimeException(&quot;Error fetching access token&quot;, e);</span>
        }
    }


    protected &lt;RES&gt; HttpResponse&lt;RES&gt; request(RunContext runContext, HttpRequest.HttpRequestBuilder requestBuilder, Class&lt;RES&gt; responseType)
        throws HttpClientException, IllegalVariableEvaluationException {

<span class="fc" id="L141">        requestBuilder</span>
<span class="fc" id="L142">            .addHeader(&quot;Content-Type&quot;, &quot;application/json&quot;)</span>
<span class="fc" id="L143">            .build();</span>

<span class="pc bpc" id="L145" title="1 of 2 branches missed.">        if (this.clientId != null) {</span>
<span class="fc" id="L146">            requestBuilder.addHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + this.token(runContext));</span>
        } else {
<span class="nc bnc" id="L148" title="All 2 branches missed.">            var optionsBuilder = options != null ? options.toBuilder() : HttpConfiguration.builder();</span>
<span class="nc" id="L149">            options = optionsBuilder.auth(</span>
<span class="nc" id="L150">                BasicAuthConfiguration.builder()</span>
<span class="nc" id="L151">                    .username(this.username)</span>
<span class="nc" id="L152">                    .password(this.password).build()</span>
<span class="nc" id="L153">            ).build();</span>
        }

<span class="fc" id="L156">        var request = requestBuilder.build();</span>
<span class="fc" id="L157">        try (HttpClient client = new HttpClient(runContext, options)) {</span>
<span class="fc" id="L158">            HttpResponse&lt;String&gt; response = client.request(request, String.class);</span>
<span class="fc" id="L159">            RES parsedResponse = null;</span>
<span class="pc bpc" id="L160" title="2 of 6 branches missed.">            if (responseType != Void.class &amp;&amp; response.getBody() != null &amp;&amp; !response.getBody().isEmpty()) {</span>
<span class="fc" id="L161">                parsedResponse = MAPPER.readValue(response.getBody(), responseType);</span>
            }

<span class="fc" id="L164">            return HttpResponse.&lt;RES&gt;builder()</span>
<span class="fc" id="L165">                .request(request)</span>
<span class="fc" id="L166">                .body(parsedResponse)</span>
<span class="fc" id="L167">                .headers(response.getHeaders())</span>
<span class="fc" id="L168">                .status(response.getStatus())</span>
<span class="fc" id="L169">                .build();</span>
<span class="nc" id="L170">        } catch (HttpClientResponseException e) {</span>
<span class="nc" id="L171">            throw new HttpClientResponseException(</span>
<span class="nc" id="L172">                &quot;Request failed '&quot; + Objects.requireNonNull(e.getResponse()).getStatus().getCode() +</span>
<span class="nc" id="L173">                    &quot;' and body '&quot; + e.getResponse().getBody() + &quot;'&quot;,</span>
<span class="nc" id="L174">                e.getResponse()</span>
            );
<span class="nc" id="L176">        } catch (IOException e) {</span>
<span class="nc" id="L177">            throw new RuntimeException(&quot;Error parsing response body&quot;, e);</span>
        }
    }

    protected String appendQueryParams(RunContext runContext,
        String baseUrl,
        Map&lt;String, Object&gt; extraParams) throws IllegalVariableEvaluationException {
<span class="fc" id="L184">        StringBuilder url = new StringBuilder(baseUrl);</span>
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">        boolean first = !baseUrl.contains(&quot;?&quot;);</span>
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">        if (this.params != null) {</span>
<span class="nc" id="L187">            Map&lt;String, Object&gt; map = runContext.render(this.params).asMap(String.class, Object.class);</span>
<span class="nc" id="L188">            first = appendParams(url, runContext, map, first);</span>
        }
<span class="pc bpc" id="L190" title="3 of 4 branches missed.">            if (extraParams != null &amp;&amp; !extraParams.isEmpty()) {</span>
<span class="nc" id="L191">            first = appendParams(url, runContext, extraParams, first);</span>
        }
<span class="fc" id="L193">        return url.toString();</span>
    }
    private boolean appendParams(StringBuilder url,
                                 RunContext runContext,
                                 Map&lt;String, Object&gt; map,
                                 boolean first) throws IllegalVariableEvaluationException {

<span class="nc bnc" id="L200" title="All 2 branches missed.">        for (Map.Entry&lt;String, Object&gt; e : map.entrySet()) {</span>
<span class="nc" id="L201">            String key = runContext.render(e.getKey());</span>
<span class="nc" id="L202">            Object raw = e.getValue();</span>

<span class="nc bnc" id="L204" title="All 2 branches missed.">            if (raw instanceof Iterable&lt;?&gt; it) {</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">                for (Object item : it) {</span>
<span class="nc" id="L206">                    first = appendQuery(url, first, key, runContext.render(String.valueOf(item)));</span>
<span class="nc" id="L207">                }</span>
            } else {
<span class="nc" id="L209">                first = appendQuery(url, first, key, runContext.render(String.valueOf(raw)));</span>
            }
<span class="nc" id="L211">        }</span>
<span class="nc" id="L212">        return first;</span>
    }

    private boolean appendQuery(StringBuilder url, boolean first, String key, String value) {
<span class="nc bnc" id="L216" title="All 2 branches missed.">        url.append(first ? '?' : '&amp;')</span>
<span class="nc" id="L217">           .append(URLEncoder.encode(key, StandardCharsets.UTF_8))</span>
<span class="nc" id="L218">           .append('=')</span>
<span class="nc" id="L219">           .append(URLEncoder.encode(value, StandardCharsets.UTF_8));</span>
<span class="nc" id="L220">        return false;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>